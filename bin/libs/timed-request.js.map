{"version":3,"sources":["libs/timed-request.es6"],"names":[],"mappings":"AAAA;;;;AAIA;;AAEA,IAAM,OAAO,QAAQ,MAAR,CAAb;AACA,IAAM,UAAU,QAAQ,SAAR,CAAhB;AACA,IAAM,SAAS,QAAQ,QAAR,CAAf;AACA,IAAM,WAAW,QAAQ,aAAR,CAAjB;;AAEA,IAAI,gBAAgB,EAApB;AACA,IAAI,kBAAkB,KAAtB;AACA,IAAI,eAAe,IAAnB;;AAEA,SAAS,YAAT,CAAsB,OAAtB,EAA+B,QAA/B,EAAyC;AACrC,kBAAc,IAAd,CAAmB,EAAE,gBAAF,EAAW,kBAAX,EAAnB;;AAEA,QAAI,CAAC,eAAL,EAAsB;AAClB,0BAAkB,IAAlB;;AAEA,YAAI,iBAAiB,IAArB,EAA2B;AACvB,mBAAO,QAAQ,QAAR,CAAiB,aAAa,OAA9B,CAAP;AACH;;AAED,YAAI,OAAO,SAAS,YAAT,CAAX;AACA,YAAI,QAAQ,aAAa,QAAb,EAAZ,EAAqC;AACjC,mBAAO,QAAQ,QAAR,CAAiB,aAAa,OAA9B,CAAP;AACH;;AAED,mBAAW,aAAa,OAAxB,EAAiC,aAAa,QAAb,KAA0B,IAA3D;AACH;AACJ;;AAED,KAAK,QAAL,CAAc,YAAd,EAA4B,MAA5B;;AAEA,OAAO,gBAAP,CAAwB,YAAxB,EAAsC;AAClC,eAAW;AACP,iBAAS,iBAAW;AAChB,8BAAkB,IAAlB;;AAEA,gBAAI,OAAO,cAAc,KAAd,EAAX;;AAEA;AACA,yBAAa,KAAb,CAAmB,aAAa,QAAb,EAAnB,EAA4C,UAAC,QAAD,EAAc;AACtD,wBAAQ,KAAK,OAAb,EAAsB,QAAtB;;AAEA,kCAAkB,KAAlB;AACA,+BAAe,QAAQ,MAAR,EAAf;AACA,oBAAI,cAAc,MAAd,GAAuB,CAA3B,EAA8B;AAC1B,sCAAkB,IAAlB;AACA,4BAAQ,QAAR,CAAiB,aAAa,OAA9B;AACH;AACJ,aATD,EASG,KAAK,QATR;AAUH;AAjBM,KADuB;;AAqBlC,aAAS;AACL,iBAAS,eAAS,QAAT,EAAmB,SAAnB,EAA8B,QAA9B,EAAwC;AAC7C,gBAAI,QAAQ,QAAQ,MAAR,EAAZ;;AAEA,sBAAU,IAAV,CAAe,IAAf,EAAqB,YAAa;AAAA,kDAAT,IAAS;AAAT,wBAAS;AAAA;;AAC9B,oBAAI,OAAO,SAAS,KAAT,CAAX;AACA,oBAAI,QAAQ,QAAZ,EAAsB;AAClB,2BAAO,SAAS,IAAT,kBAAc,IAAd,SAAuB,IAAvB,EAAP;AACH;;AAED,2BAAW,YAAM;AACb,2BAAO,SAAS,IAAT,kBAAc,IAAd,SAAuB,IAAvB,EAAP;AACH,iBAFD,EAEG,WAAW,IAFd;AAGH,aATD;AAUH;AAdI,KArByB;;AAsClC,gBAAY;AACR,iBAAS,eAAS,MAAT,EAAgB;AACrB,gBAAI,OAAO,QAAP,CAAgB,MAAhB,CAAJ,EAA4B;AACxB,6BAAa,SAAb,GAAyB,MAAzB;AACH;;AAED,mBAAO,aAAa,SAApB;AACH;AAPO;AAtCsB,CAAtC;;AAiDA;AACA,aAAa,QAAb,CAAsB,GAAtB;;AAEA,OAAO,OAAP,GAAiB,YAAjB","file":"libs/timed-request.js","sourcesContent":["/**\r\n * Created by Paul on 07/08/2016.\r\n */\r\n\r\n'use strict';\r\n\r\nconst util = require('util');\r\nconst request = require('request');\r\nconst TypeOf = require('typeof');\r\nconst timeDiff = require('./time-diff');\r\n\r\nlet REQUEST_QUEUE = [];\r\nlet REQUEST_PENDING = false;\r\nlet REQUEST_LAST = null;\r\n\r\nfunction TimedRequest(options, callback) {\r\n    REQUEST_QUEUE.push({ options, callback });\r\n\r\n    if (!REQUEST_PENDING) {\r\n        REQUEST_PENDING = true;\r\n\r\n        if (REQUEST_LAST === null) {\r\n            return process.nextTick(TimedRequest.consume);\r\n        }\r\n\r\n        let diff = timeDiff(REQUEST_LAST);\r\n        if (diff >= TimedRequest.duration()) {\r\n            return process.nextTick(TimedRequest.consume);\r\n        }\r\n\r\n        setTimeout(TimedRequest.consume, TimedRequest.duration() - diff);\r\n    }\r\n}\r\n\r\nutil.inherits(TimedRequest, Object);\r\n\r\nObject.defineProperties(TimedRequest, {\r\n    'consume': {\r\n        'value': function() {\r\n            REQUEST_PENDING = true;\r\n\r\n            let data = REQUEST_QUEUE.shift();\r\n\r\n            // Enforce a minimum time constraint (can take longer)\r\n            TimedRequest.timed(TimedRequest.duration(), (callback) => {\r\n                request(data.options, callback);\r\n\r\n                REQUEST_PENDING = false;\r\n                REQUEST_LAST = process.hrtime();\r\n                if (REQUEST_QUEUE.length > 0) {\r\n                    REQUEST_PENDING = true;\r\n                    process.nextTick(TimedRequest.consume);\r\n                }\r\n            }, data.callback);\r\n        }\r\n    },\r\n\r\n    'timed': {\r\n        'value': function(duration, operation, callback) {\r\n            let start = process.hrtime();\r\n\r\n            operation.call(null, (...args) => {\r\n                let time = timeDiff(start);\r\n                if (time >= duration) {\r\n                    return callback.call(null, ...args);\r\n                }\r\n\r\n                setTimeout(() => {\r\n                    return callback.call(null, ...args);\r\n                }, duration - time);\r\n            });\r\n        }\r\n    },\r\n\r\n    'duration': {\r\n        'value': function(value) {\r\n            if (TypeOf.isNumber(value)) {\r\n                TimedRequest._duration = value;\r\n            }\r\n\r\n            return TimedRequest._duration;\r\n        }\r\n    }\r\n});\r\n\r\n// Default duration\r\nTimedRequest.duration(350);\r\n\r\nmodule.exports = TimedRequest;\r\n"],"sourceRoot":"/source/"}